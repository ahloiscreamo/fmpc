#!/usr/bin/env bash

# ANSI color codes
G="\033[1;32m"
Y="\033[1;33m"
R="\033[1;31m"
M="\033[1;35m"
C="\033[1;36m"
W="\033[0;90m"
WH="\033[1;37m"
NC="\033[0m"

# Help dialog
if [[ "$1" == "--help" || "$1" == "-h" ]]; then
    echo -e "${M}fmpc${NC} - Fast MPC Browser"
    echo -e "--------------------------------"
    echo -e "${G}ENTER${NC}      : Play highlighted song"
    echo -e "${Y}TAB${NC}        : Select/Deselect multiple songs"
    echo -e "${G}Ctrl-x${NC}     : Play all selected songs"
    echo -e "${C}Ctrl-f${NC}     : Search for the currently playing song"
    echo -e "${M}Ctrl-p/n/b${NC} : Toggle/Next/Prev"
    echo -e "${R}Ctrl-q${NC}     : Quit"
    echo -e "${Y}ESC${NC}        : Clear search and jump to top"
    echo -e "--------------------------------"
    exit 0
fi

# Paths and temp files
export MUSIC_DIR="/mnt/Kingston/Music"
FIFO_PIPE="/tmp/fmpc_fifo"
UB_PID_FILE="/tmp/fmpc_ub.pid"
CACHE_DIR="$HOME/.cache/fmpc"

# Set layout here: "right" or "bottom"
export PREVIEW_POS="bottom"
PREVIEW_SIZE="50%"

# Handler for fzf preview window
if [[ "$1" == "--preview" ]]; then
    [[ -z "$2" ]] && exit
    
    FILE="$2"
    FULL_PATH="$MUSIC_DIR/$FILE"
    ALBUM_DIR=$(dirname "$FILE")
    ALBUM_HASH=$(echo "$ALBUM_DIR" | md5sum | cut -d' ' -f1)
    ALBUM_COVER="$CACHE_DIR/${ALBUM_HASH}.jpg"

    mkdir -p "$CACHE_DIR"

    # Extract cover art if missing
    if [[ ! -f "$ALBUM_COVER" ]]; then
        timeout 2s ffmpeg -i "$FULL_PATH" -an -vframes 1 -q:v 2 "$ALBUM_COVER" -y >/dev/null 2>&1
    fi

    # Center text only if layout is set to bottom
    center_text() {
        local text="$1"
        if [[ "$PREVIEW_POS" == "bottom" ]]; then
            local clean_text=$(echo -e "$text" | sed 's/\x1b\[[0-9;]*m//g')
            local width=${FZF_PREVIEW_COLUMNS:-80}
            local n=${#clean_text}
            local pad=$(( (width - n) / 2 ))
            [[ $pad -lt 0 ]] && pad=0
            printf "%${pad}s" " "
        fi
        echo -e "$text"
    }

    # Draw preview header and metadata
    SEP_LINE=$(printf '%.0s-' $(seq 1 ${FZF_PREVIEW_COLUMNS:-40}))
    center_text "${W}${SEP_LINE}${NC}"
    
    CURRENT=$(mpc current -f "%file%")
    if [[ "$FILE" == "$CURRENT" ]]; then
        center_text "${G}[ NOW PLAYING ]${NC}"
    else
        center_text "${W}[ Selected ]${NC}"
    fi

    center_text "${M}Album:${NC} ${WH}$ALBUM_DIR${NC}"
    center_text "${C}Track:${NC} ${WH}${FILE##*/}${NC}"
    center_text "${W}${SEP_LINE}${NC}"

    # Render image using ueberzugpp
    if [[ -f "$ALBUM_COVER" && -p "$FIFO_PIPE" ]]; then
        if [[ "$PREVIEW_POS" == "bottom" ]]; then
            # Centered layout for bottom mode
            IMG_H=$((FZF_PREVIEW_LINES - 5))
            
            # Use visual square ratio for width
            VISUAL_SQUARE_WIDTH=$((IMG_H * 5 / 2)) 
            [[ $VISUAL_SQUARE_WIDTH -gt $FZF_PREVIEW_COLUMNS ]] && VISUAL_SQUARE_WIDTH=$FZF_PREVIEW_COLUMNS

            # Calc X with +2 nudge for centering
            IMG_X=$(( FZF_PREVIEW_LEFT + (FZF_PREVIEW_COLUMNS - VISUAL_SQUARE_WIDTH) / 2 + 2 ))
            IMG_W=$VISUAL_SQUARE_WIDTH
            OFFSET_Y=$((FZF_PREVIEW_TOP + 5))
        else
            # Standard left-aligned layout for right mode
            IMG_X=$FZF_PREVIEW_LEFT
            IMG_W=$FZF_PREVIEW_COLUMNS
            IMG_H=$((FZF_PREVIEW_LINES - 6))
            OFFSET_Y=$((FZF_PREVIEW_TOP + 6))
        fi

        printf '{"action": "remove", "identifier": "fmpc-preview"}\n' > "$FIFO_PIPE"
        printf '{"action": "add", "identifier": "fmpc-preview", "x": %d, "y": %d, "width": %d, "height": %d, "scaler": "contain", "path": "%s"}\n' \
            "$IMG_X" "$OFFSET_Y" "$IMG_W" "$IMG_H" "$ALBUM_COVER" > "$FIFO_PIPE"
    fi
    exit
fi

# Clean up our mess on exit
cleanup() {
    # The follower script now has its own trap to clean up its children.
    # We just need to send it a normal termination signal (SIGTERM).
    if [ -f "$FOLLOW_PID_FILE" ]; then
        follower_pid=$(cat "$FOLLOW_PID_FILE")
        kill "$follower_pid" 2>/dev/null
    fi
    [ -f "$UB_PID_FILE" ] && kill -9 "$(cat "$UB_PID_FILE")" 2>/dev/null # kill ueberzug too

    # now it's safe to restore the terminal
    tput cnorm; tput rmcup;

    # and finally, delete the temp files. no sleep needed.
    rm -f "$UB_PID_FILE" "$FIFO_PIPE" "$FOLLOW_PID_FILE" "$LIST_CACHE" "$FZF_SOCK_PATH"
    exit
}
trap cleanup EXIT


# --- Setup ---

# ueberzug++ for album art
rm -f "$FIFO_PIPE"
mkfifo "$FIFO_PIPE"
ueberzugpp layer --silent < <(tail -f "$FIFO_PIPE") &
echo $! > "$UB_PID_FILE"

# File paths
LIST_CACHE="/tmp/fmpc_list_cache"
FOLLOW_PID_FILE="/tmp/fmpc_follow.pid"
FZF_SOCK_PATH="/tmp/fmpc.sock"
FOLLOWER_SCRIPT="$HOME/.local/bin/fmpc-follower"

# Cache mpc's full list for much faster lookups later
mpc listall > "$LIST_CACHE"

# Figure out where to jump on start
current_file=$(mpc current -f "%file%")
initial_jump_index=1 # default to top
if [[ -n "$current_file" ]]; then
    index_from_awk=$(awk -v song="$current_file" '$0 == song { print NR; exit }' "$LIST_CACHE")
    if [[ -n "$index_from_awk" ]]; then
        initial_jump_index=$index_from_awk
    fi
fi

# TUI formatting
DIR_COL=$'\e[35m'
FILE_COL=$'\e[37m'
RESET=$'\e[0m'

# Switch list formatting and header based on layout
if [[ "$PREVIEW_POS" == "bottom" ]]; then
    # Use sed on the cache file instead of piping mpc listall every time
    LIST_CMD="sed \"s|^.*/\(.*\)$|${FILE_COL}\1${RESET}\t&|\" $LIST_CACHE"
    L1="ENTER ${G}${NC} Play ${W}|${NC} TAB ${Y}󰄳${NC} Sel   ${W}|${NC} C-x ${G}${NC} Play Sel"
    L2="C-q ${R}${NC} Quit   ${W}|${NC} ESC ${M}${NC} Clear ${W}|${NC} C-f ${C}${NC} Find"
    HEADER_TEXT=$(echo -e "$L1\n$L2")
else
    LIST_CMD="sed \"s|^\(.*\)/\(.*\)$|${DIR_COL}\1/${FILE_COL}\2${RESET}\t\1/\2|\" $LIST_CACHE"
    HEADER_TEXT=$(echo -e "ENTER ${G}${NC} Play ${W}|${NC} TAB ${Y}󰄳${NC} Sel ${W}|${NC} C-x ${G}${NC} Play Sel ${W}|${NC} C-q ${R}${NC} Quit ${W}|${NC} ESC ${M}${NC} Clear ${W}|${NC} C-f ${C}${NC} Find")
fi


# --- Launch fzf ---

# Note: --listen tells fzf to use our specified socket
# 'start:execute(...)' launches our follower script in the background
eval "$LIST_CMD" | fzf \
    --ansi \
    --delimiter '\t' \
    --with-nth=1 \
    --multi \
    --listen="$FZF_SOCK_PATH" \
    --header "$HEADER_TEXT" \
    --prompt " 󰎆 Music > " \
    --preview "$0 --preview {2}" \
    --preview-window="${PREVIEW_POS}:${PREVIEW_SIZE}:border-rounded" \
    --bind "load:pos($initial_jump_index)" \
    --bind "start:execute($FOLLOWER_SCRIPT '$LIST_CACHE' '$FZF_SOCK_PATH' & echo \$! > '$FOLLOW_PID_FILE')" \
    --bind "enter:execute-silent($HOME/.local/bin/fmpc-play {2} >/dev/null 2>&1)+refresh-preview" \
    --bind "ctrl-x:execute($HOME/.local/bin/fmpc-play {+2} >/dev/null 2>&1)+deselect-all" \
    --bind "esc:change-query()+top" \
    --bind "change:top" \
    --bind "ctrl-f:transform-query(mpc current -f '%file%' | sed 's|.*/||')" \
    --bind "ctrl-p:execute-silent(mpc toggle >/dev/null 2>&1)+refresh-preview" \
    --bind "ctrl-n:execute-silent(mpc next >/dev/null 2>&1)+refresh-preview" \
    --bind "ctrl-b:execute-silent(mpc prev >/dev/null 2>&1)+refresh-preview" \
    --bind "ctrl-u:execute-silent(mpc update >/dev/null 2>&1)+refresh-preview" \
    --bind "ctrl-q:abort" \
    --reverse --border
