#!/usr/bin/env bash

# UI Colors
G="\033[1;32m"
Y="\033[1;33m"
R="\033[1;31m"
M="\033[1;35m"
C="\033[1;36m"
W="\033[0;90m"
WH="\033[1;37m"
NC="\033[0m"

# Help menu
if [[ "$1" == "--help" || "$1" == "-h" ]]; then
    echo -e "${M}fmpc${NC} - Fast MPC Browser"
    echo -e "--------------------------------"
    echo -e "${G}ENTER${NC}      : Play highlighted song"
    echo -e "${Y}TAB${NC}        : Select/Deselect multiple songs"
    echo -e "${G}Ctrl-x${NC}    : Play all selected songs"
    echo -e "${C}Ctrl-f${NC}    : Search for the currently playing song"
    echo -e "${M}Ctrl-p/n/b${NC}: Toggle/Next/Prev"
    echo -e "${R}Ctrl-q${NC}    : Quit"
    echo -e "${Y}ESC${NC}        : Clear search and jump to top"
    echo -e "--------------------------------"
    exit 0
fi

# Config & Temp files
export MUSIC_DIR="/mnt/Kingston/Music"
FIFO_PIPE="/tmp/fmpc_fifo"
UB_PID_FILE="/tmp/fmpc_ub.pid"
CACHE_DIR="$HOME/.cache/fmpc"

# FZF Preview Handler
if [[ "$1" == "--preview" ]]; then
    [[ -z "$2" ]] && exit
    
    FILE="$2"
    FULL_PATH="$MUSIC_DIR/$FILE"
    ALBUM_DIR=$(dirname "$FILE")
    ALBUM_HASH=$(echo "$ALBUM_DIR" | md5sum | cut -d' ' -f1)
    ALBUM_COVER="$CACHE_DIR/${ALBUM_HASH}.jpg"

    mkdir -p "$CACHE_DIR"

    # Extract cover if not cached
    if [[ ! -f "$ALBUM_COVER" ]]; then
        timeout 2s ffmpeg -i "$FULL_PATH" -an -vframes 1 -q:v 2 "$ALBUM_COVER" -y >/dev/null 2>&1
    fi

    # Metadata display
    echo -e "${W}--------------------------------${NC}"
    CURRENT=$(mpc current -f "%file%")
    if [[ "$FILE" == "$CURRENT" ]]; then
        echo -e "${G}[ NOW PLAYING ]${NC}"
    else
        echo -e "${W}[ Selected ]${NC}"
    fi

    echo -e "${M}Album:${NC} ${WH}$ALBUM_DIR${NC}"
    echo -e "${C}Track:${NC} ${WH}${FILE##*/}${NC}"
    echo -e "${W}--------------------------------${NC}"

    # UeberzugPP draw
    if [[ -f "$ALBUM_COVER" && -p "$FIFO_PIPE" ]]; then
        OFFSET_Y=$((FZF_PREVIEW_TOP + 6))
        HEIGHT_ADJUST=$((FZF_PREVIEW_LINES - 6))
        printf '{"action": "remove", "identifier": "fmpc-preview"}\n' > "$FIFO_PIPE"
        printf '{"action": "add", "identifier": "fmpc-preview", "x": %d, "y": %d, "width": %d, "height": %d, "scaler": "contain", "path": "%s"}\n' \
            "$FZF_PREVIEW_LEFT" "$OFFSET_Y" "$FZF_PREVIEW_COLUMNS" "$HEIGHT_ADJUST" "$ALBUM_COVER" > "$FIFO_PIPE"
    fi
    exit
fi

# Cleanup on exit
cleanup() {
    [ -f "$UB_PID_FILE" ] && kill "$(cat "$UB_PID_FILE")" 2>/dev/null
    rm -f "$UB_PID_FILE" "$FIFO_PIPE"
    exit
}
trap cleanup EXIT

# Initialize UeberzugPP
rm -f "$FIFO_PIPE"
mkfifo "$FIFO_PIPE"
ueberzugpp layer --silent < <(tail -f "$FIFO_PIPE") &
echo $! > "$UB_PID_FILE"

# Get current song for initial query
CURRENT_SONG=$(mpc current -f "%file%" | xargs -I {} basename "{}" | sed "s/^'//;s/'$//")

# List coloring
DIR_COL=$'\e[35m'
FILE_COL=$'\e[37m'
RESET=$'\e[0m'

# Main UI
mpc listall | sed "s|^\(.*\)/\(.*\)$|${DIR_COL}\1/${FILE_COL}\2${RESET}\t\1/\2|" | fzf \
    --ansi \
    --delimiter '\t' \
    --with-nth=1 \
    --query "$CURRENT_SONG" \
    --multi \
    --header "$(echo -e "ENTER ${G}${NC} Play | TAB ${Y}󰄳${NC} Sel | C-x ${G}${NC} Play Sel | C-q ${R}${NC} Quit | ESC ${M}${NC} Clear | C-f ${C}${NC} Find")" \
    --prompt " 󰎆 Music > " \
    --preview "$0 --preview {2}" \
    --preview-window="right:40%:border-rounded" \
    --bind "enter:execute($HOME/.local/bin/fmpc-play {2})+refresh-preview" \
    --bind "ctrl-x:execute($HOME/.local/bin/fmpc-play {+2})+deselect-all" \
    --bind "esc:change-query()+top" \
    --bind "change:top" \
    --bind "ctrl-f:transform-query(mpc current -f '%file%' | xargs -I {} basename \"{}\" | sed \"s/^'//;s/'$//\")" \
    --bind "ctrl-p:execute-silent(mpc toggle)+refresh-preview" \
    --bind "ctrl-n:execute-silent(mpc next)+refresh-preview" \
    --bind "ctrl-b:execute-silent(mpc prev)+refresh-preview" \
    --bind "ctrl-u:execute-silent(mpc update)+refresh-preview" \
    --bind "ctrl-q:abort" \
    --reverse --border
